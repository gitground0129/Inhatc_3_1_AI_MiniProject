# -*- coding: utf-8 -*-
"""Insurance_prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-Uz8nghX5Hl9cNtOD4OI7mnnw-2bOByB

반: B     
학번 : 202144039              
이름: 박철원
"""

import numpy as np
import pandas as pd
from tensorflow import keras
from keras.layers import Dense
from keras.models import Sequential
from keras.callbacks import EarlyStopping, ModelCheckpoint
from sklearn.model_selection import train_test_split

from sklearn.preprocessing import MinMaxScaler

# 데이터 세트를 읽어들인다.
df = pd.read_csv("/content/insurance.csv", sep=',')


### one hot encoding으로 문자열->정수 형태 변환
df =  pd.get_dummies(df, columns=['sex', 'smoker', 'region'], drop_first=True)


X=df.iloc[:,0:6] # 입력 데이터 6개
y=df.iloc[:,6] # 의료 보험 비용

### 0~ 1 사이로 정규화
mms=MinMaxScaler()
mms.fit(X)
X_mms = mms.transform(X)
X = pd.DataFrame(X_mms, columns=X.columns, index=list(X.index.values))
print(X.head())

# 훈련/테스트 데이터 분류
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, shuffle=True)

# 모델 생성
model = Sequential()
model.add(Dense(30, input_dim=6, activation='relu'))
model.add(Dense(25, activation='tanh'))
model.add(Dense(20, activation='tanh'))
model.add(Dense(15, activation='relu'))
model.add(Dense(1))
model.summary()

model.compile(loss='mean_squared_error', optimizer='adam', metrics=['mse'])

# 조기 종료(목적: 과적합 방지)
early_stopping_callback = EarlyStopping(monitor='val_loss', patience = 5)

modelpath = './AI_Charge.keras'

# 모델 저장
checkpointer = ModelCheckpoint(filepath=modelpath, monitor='val_loss', verbose = 1, save_best_only=True)

# 테스트 데이터 이용한 성능 측정 + 검증셋 설정 75%/25%
history = model.fit(X_train, y_train, epochs = 200, batch_size = 64, validation_split=0.25, verbose =1,
                    callbacks=[early_stopping_callback, checkpointer])

###################################################

# 테스트 결과를 출력합니다.
score=model.evaluate(X_test, y_test)
print('Best Performance(MSE):', score[1])